<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>å¸å®‰ Alpha ç©ºæŠ•å®æ—¶æŸ¥è¯¢</title>
  <link rel="icon" href="favicon.ico" />
  <style>
    /* =====  åŸºç¡€æ ·å¼  ===== */
    body{
      font-family:"Segoe UI","PingFang SC","Microsoft YaHei",sans-serif;
      background:#f9f9f9;color:#333;max-width:900px;margin:40px auto;padding:20px}
    h2,h3{text-align:center;margin-bottom:20px}
    .control,.link-buttons{text-align:center;margin-bottom:20px}
    button{padding:8px 16px;font-size:15px;background:#0078d4;color:#fff;border:none;
      border-radius:6px;cursor:pointer;transition:background-color .2s}
    button:hover{background:#005fa3}button:disabled{opacity:.6;cursor:not-allowed}
    select{padding:6px 10px;font-size:15px;margin-left:10px}
    .link-buttons a{display:inline-block;margin:6px;padding:8px 16px;border-radius:6px;
      border:1px solid #0078d4;background:#fff;color:#0078d4;text-decoration:none;font-size:14px}
    .link-buttons a:hover{background:#0078d4;color:#fff}
    #errorMsg{color:#d92c2c;text-align:center;margin-bottom:10px;display:none}
    table{width:100%;border-collapse:collapse;background:#fff;
      box-shadow:0 2px 5px rgba(0,0,0,.05);border-radius:8px}
    th,td{border:1px solid #ddd;padding:12px;text-align:center}
    th{background:#f2f2f2;font-weight:bold;cursor:pointer;user-select:none}
    tr:hover{background:#f9fcff}
    .subtext{font-size:13px;color:#777}
    .pv-high{color:#28a745;font-weight:bold}
    .pv-mid{color:#ff8c00;font-weight:bold}
    th.sort-asc::after{content:"â–²";margin-left:4px;font-size:11px;color:#0078d4}
    th.sort-desc::after{content:"â–¼";margin-left:4px;font-size:11px;color:#0078d4}
    #lastUpdate,#author{text-align:center;margin-top:16px;color:#777;font-size:14px}
    #progressBlock,#surplusBlock,#merlDeadline{text-align:center;margin-top:20px}
    #progressBarContainer{width:80%;margin:0 auto;background:#eee;border-radius:6px;
      overflow:hidden;height:16px}
    #progressBar{height:100%;width:0;background:linear-gradient(to right,#0078d4,#00c6ff);
      transition:width .5s}
    .discount-note{font-size:13px;color:#888}
    #countdownBar{width:80%;height:8px;background:#ffe4e4;border-radius:6px;overflow:hidden;
      margin:6px auto 0;display:none}
    #countdownBarInner{height:100%;width:100%;background:#e55353;transition:width 1s}
    .dual-countdown{display:flex;gap:20px;justify-content:center;margin-top:20px;flex-wrap:wrap}
    .cd-card{background:#fff;border:1px solid #ddd;border-radius:6px;padding:10px 16px;
      box-shadow:0 2px 5px rgba(0,0,0,.05);min-width:120px;text-align:center}
    .cd-card strong{display:block;margin-bottom:4px}.cd-time{color:#e55353;font-weight:bold;font-size:14px}
  </style>
</head>
<body>
<h2>å¸å®‰ Alpha ç©ºæŠ•å®æ—¶æ•°æ®å±•ç¤º</h2>

<!-- ===== æ§ä»¶åŒº ===== -->
<div class="control">
  <button id="refreshBtn">ğŸ”„ åˆ·æ–°æ•°æ®</button>
  <button id="historyBtn">ğŸ—‚ï¸ å†å²æ€»è§ˆ</button>
  <select id="tokenSelect">
    <option value="BULLA" selected>BULLA</option>
    <option value="BRIC">BRIC</option>
    <option value="SPK">SPK</option><option value="VELO">VELO</option><option value="F">F</option>
    <option value="ROAM">ROAM</option><option value="PUNDIA">PUNDIA</option>
    <option value="TODAY">ä»Šæ—¥åŒç©ºæŠ• (RESOLV + HOME)</option>
    <option value="SKATE">SKATE</option><option value="LA">LA</option><option value="ASRR">ASRR</option>
    <option value="SOPH">SOPH</option><option value="OBT">OBT</option><option value="MERL">MERL</option>
    <option value="XTER">XTER</option><option value="TGT">TGT</option><option value="Soon">Soon</option>
    <option value="HUMA">HUMA</option><option value="PFVS">PFVS</option><option value="TAIKO">TAIKO</option>
    <option value="EDGEN">EDGEN</option><option value="SQD">SQD</option><option value="ZRC">ZRC</option>
    <option value="BDXN">BDXN</option><option value="AB">AB</option><option value="OL">OL</option>
    <option value="RESOLV">RESOLV</option><option value="HOME">HOME</option>
    <option value="FLY">FLY</option><option value="SERAPH">SERAPH</option><option value="DEGEN">DEGEN</option>
    <option value="ULTI">ULTI</option><option value="MAT">MAT</option><option value="AVAIL">AVAIL</option>
  </select>
</div>

<div class="link-buttons">
  <a href="https://debank.com/profile/0x73D8bD54F7Cf5FAb43fE4Ef40A62D390644946Db" target="_blank">ğŸ“¦ åˆ†å‘ç©ºæŠ•åœ°å€</a>
  <a href="https://bscscan.com/address/0x497f4521d79925989ae304c7caf84ed57988e88a" target="_blank">ğŸ“œ Web3 IDO åˆçº¦</a>
</div>

<div id="errorMsg">âš ï¸ æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚</div>

<!-- ===== è¿›åº¦è¡¨ ===== -->
<h3>ğŸ“Š ç©ºæŠ•å‘æ”¾è¿›åº¦</h3>
<table>
  <thead>
    <tr><th>ä»£å¸</th><th>ä»·æ ¼</th><th>å•å·ä»·å€¼</th><th>ä»£å¸æ•°é‡</th>
        <th>æœªé¢†å–</th><th>å·²é¢†å–</th><th>è¾¾æ ‡ / å·²é¢†</th></tr>
  </thead>
  <tbody id="tokenBody"></tbody>
</table>

<div id="progressBlock">
  <p>ğŸ“ˆ å·²é¢†å–è¿›åº¦ï¼š<span id="claimedPercent">-</span>%</p>
  <div id="progressBarContainer"><div id="progressBar"></div></div>
</div>

<h3 id="surplusTitle">ğŸ“Œ å‰©ä½™é¢†å–ä¿¡æ¯</h3>
<div id="surplusBlock">
  <p>å‰©ä½™å¯åˆ†ä»£å¸ï¼š<span id="surplusToken">-</span></p>
  <p>å¯¹åº”ä»·å€¼ï¼š<span id="surplusValue">-</span></p>
  <p class="discount-note">* æ˜¾ç¤ºä¸º 85% ä¿å®ˆä¼°ç®—</p>
</div>

<!-- ===== æˆªæ­¢æ—¶é—´ ===== -->
<h3>â³ ç©ºæŠ•é¢†å–æˆªæ­¢</h3>
<div id="merlDeadline"></div>
<div id="countdownBar"><div id="countdownBarInner"></div></div>

<!-- åŒå€’è®¡æ—¶å¡ç‰‡ -->
<div id="dualCountdown" class="dual-countdown" style="display:none;"></div>

<!-- ===== å¾€æœŸæ€»è§ˆ ===== -->
<h3 style="display:none" id="historyTitle">ğŸ—‚ï¸ å¾€æœŸç©ºæŠ•æ€»è§ˆ</h3>
<div id="historyBlock" style="display:none">
  <table>
    <thead>
      <tr>
        <th>ä»£å¸</th><th>ç»“æŸæ—¶é—´</th><th>ä»·æ ¼</th>
        <th data-sort-key="ticket">å•å·ä»·å€¼</th>
        <th>ä»£å¸æ•°é‡</th>
        <th data-sort-key="usd">USD é‡‘é¢</th>
      </tr>
    </thead>
    <tbody id="historyBody"></tbody>
  </table>
  <p id="historyTotal" style="text-align:center;margin-top:10px;color:#555"></p>
</div>

<div id="lastUpdate">ğŸ“… ä¸Šæ¬¡æ›´æ–°äº --:--:--</div>
<div id="author">ğŸ‘¤ <a href="https://x.com/0xXIAOc" target="_blank" style="color:#0078d4;">@0xXIAOc</a></div>

<script>
/****************  ä»£å¸é…ç½®  ****************/
const TOKENS = {
  BULLA:{name:"BULLA",contract:"0x595e21b20e78674f8a64c1566a20b2b316bc3511",
        totalSupply:29925000,perUserAmount:750,claimedUsers:7700},
  BRIC:{name:"BRIC",contract:"0xb40f2e5291c3db45abb0ca8df76f1c21e9f112a9",
        totalSupply:22500000,perUserAmount:900,claimedUsers:2834},
  SPK:{name:"SPK",contract:"0xaff2e841851700d1fc101995ee6b81ae21bb87d7",
       totalSupply:100000000,perUserAmount:2000,claimedUsers:39809},
  VELO:{name:"VELO",contract:"0xf486ad071f3bee968384d2e39e2d8af0fcf6fd46",
       totalSupply:279749989,perUserAmount:5000,claimedUsers:51282},
  F:{name:"F",contract:"0xc9ccbd76c2353e593cc975f13295e8289d04d3bb",
       totalSupply:198000000,perUserAmount:5000,claimedUsers:32716},
  PUNDIA:{name:"PUNDIA",contract:"0x67aa700ab0110cc52bf7f308fe25068e87a0f581",
       totalSupply:562228,perUserAmount:8,claimedUsers:14172},
  RESOLV:{name:"RESOLV",contract:"0xda6cef7f667d992a60eb823ab215493aa0c6b360",
       totalSupply:9900000,perUserAmount:400,claimedUsers:23289},
  HOME:{name:"HOME",contract:"0x4bfaa776991e85e5f8b1255461cbbd216cfc714f",
       totalSupply:123750000,perUserAmount:2500,claimedUsers:25330},
  LA:{name:"LA",contract:"0x389AD4bb96d0D6EE5B6eF0EFAF4b7db0bA2e02a0",
       totalSupply:4950000,perUserAmount:160,claimedUsers:19856},
  ASRR:{name:"ASRR",contract:"0xf7626c7ff7b778aaf187d508d056a9398d9545d1",
       totalSupply:2986966,perUserAmount:133,claimedUsers:13174},
  SOPH:{name:"SOPH",contract:"0x31dba3c96481fde3cd81c2aaf51f2d8bf618c742",
       totalSupply:99743750,perUserAmount:1250,claimedUsers:52907},
  OBT:{name:"OBT",contract:"0xcef5b397051fc92026249670e918c0ad7b8585e4",
       totalSupply:179560000,perUserAmount:8000,claimedUsers:12872},
  MERL:{name:"MERL",contract:"0xa0c56a8c0692bd10b3fa8f8ba79cf5332b7107f9",
       totalSupply:31364000,perUserAmount:1000,claimedUsers:17612},
  XTER:{name:"XTER",contract:"0x103071da56e7cd95b415320760d6a0ddc4da1ca5",
       totalSupply:9967366,perUserAmount:294,claimedUsers:18942},
  SKATE:{name:"SKATE",contract:"0x61dbbbb552dc893ab3aad09f289f811e67cef285",
       totalSupply:34650000,perUserAmount:800,claimedUsers:10886},
  TGT:{name:"TGT",contract:"0x6c58e4a513d3a8062e57f41a1442e003af14ebb5",
       totalSupply:9962500,perUserAmount:500,claimedUsers:8321},
  Soon:{name:"Soon",contract:"0xb9e1fd5a02d3a33b25a14d661414e6ed6954a721",
       totalSupply:14964300,perUserAmount:180,claimedUsers:43566},
  HUMA:{name:"HUMA",contract:"0x92516e0ddf1ddbf7fab1b79cac26689fdc5ba8e6",
       totalSupply:59873750,perUserAmount:1250,claimedUsers:30664},
  PFVS:{name:"PFVS",contract:"0x3157874a7508fcf972379d24590c6806522b784f",
       totalSupply:17457125,perUserAmount:875,claimedUsers:7358},
  TAIKO:{name:"TAIKO",contract:"0x30c60b20c25b2810ca524810467a0c342294fc61",
       totalSupply:9900000,perUserAmount:130,claimedUsers:43338},
  EDGEN:{name:"EDGEN",contract:"0x0C808F0464C423d5Ea4F4454fcc23B6E2Ae75562",
       totalSupply:29700000,perUserAmount:1111,claimedUsers:4062},
  SQD:{name:"SQD",contract:"0xe50e3d1a46070444f44df911359033f2937fcc13",
       totalSupply:29781675,perUserAmount:424,claimedUsers:46356},
  ZRC:{name:"ZRC",contract:"0xdac991621fd8048d9f235324780abd6c3ad26421",
       totalSupply:178200000,perUserAmount:2666,claimedUsers:24871},
  BDXN:{name:"BDXN",contract:"0x1036b2379f506761f237fba7463857924ef21ce3",
       totalSupply:29700000,perUserAmount:900,claimedUsers:19787},
  AB:{name:"AB",contract:"0x95034f653d5d161890836ad2b6b8cc49d14e029a",
       totalSupply:489177123,perUserAmount:9882,claimedUsers:24928},
  OL:{name:"OL",contract:"0x3f160760535eb715d5809a26cf55408a2d9844c1",
       totalSupply:61875000,perUserAmount:1836,claimedUsers:10081},
  ROAM:{name:"ROAM",contract:"0x3fefe29da25bea166fb5f6ade7b5976d2b0e586b",
       totalSupply:14812875,perUserAmount:372,claimedUsers:17486},
  FLY:{name:"FLY",contract:"0x6c9b3a74ae4779da5ca999371ee8950e8db3407f",
       totalSupply:1000000,perUserAmount:88,claimedUsers:4125},
  SERAPH:{name:"SERAPH",contract:"0xd6b48ccf41a62eb3891e58d0f006b19b01d50cca",
       totalSupply:12375000,perUserAmount:61,claimedUsers:162266},
  DEGEN:{name:"DEGEN",contract:"0x4ed4e862860bed51a9570b96d89af5e1b0efefed",
       totalSupply:274472074,perUserAmount:13862,claimedUsers:14611},
  ULTI:{name:"ULTI",contract:"0x0e7779e698052f8fe56c415c3818fcf89de9ac6d",
       totalSupply:198000000,perUserAmount:2543,claimedUsers:58945},
  MAT:{name:"MAT",contract:"0xfe2dd2d57a05f89438f3aec94eafa4070396bab0",
       totalSupply:1120000,perUserAmount:16,claimedUsers:28109},
  AVAIL:{name:"AVAIL",contract:"0x39702843a6733932ec7ce0dde404e5a6dbd8c989",
       totalSupply:159753300,perUserAmount:2667,claimedUsers:49029} // å›ºå®šé¢†å–äººæ•°
};

/****************  æˆªæ­¢æ—¶é—´  ****************/
const endTimes = {
  BULLA:"2025-06-23T18:00:00+08:00",
  BRIC:"2025-06-22T18:00:00+08:00",
  SPK:"2025-06-18T16:00:00+08:00",VELO:"2025-06-17T15:00:00+08:00",
  F:"2025-06-16T16:00:00+08:00",PUNDIA:"2025-06-13T14:00:00+08:00",
  RESOLV:"2025-06-11T21:00:00+08:00",HOME:"2025-06-11T19:00:00+08:00",
  LA:"2025-06-05T20:00:00+08:00",ASRR:"2025-05-31T21:00:00+08:00",
  SOPH:"2025-05-29T20:05:00+08:00",MERL:"2025-05-21T17:00:00+08:00",
  TGT:"2025-05-22T18:00:00+08:00",Soon:"2025-05-24T16:00:00+08:00",
  OBT:"2025-05-25T16:00:00+08:00",HUMA:"2025-05-27T19:00:00+08:00",
  PFVS:"2025-05-28T20:00:00+08:00",TAIKO:"2025-06-01T14:00:00+08:00",
  EDGEN:"2025-06-03T18:30:00+08:00",SQD:"2025-06-03T21:00:00+08:00",
  ZRC:"2025-06-04T16:30:00+08:00",BDXN:"2025-06-04T18:00:00+08:00",
  AB:"2025-06-08T14:00:00+08:00",OL:"2025-06-09T14:00:00+08:00",
  SKATE:"2025-06-10T18:00:00+08:00",ROAM:"2025-06-14T21:00:00+08:00",
  FLY:"2025-06-07T21:00:00+08:00",SERAPH:"2025-06-10T20:00:00+08:00",
  DEGEN:"2025-06-15T15:00:00+08:00",ULTI:"2025-06-17T18:00:00+08:00",
  MAT:"2025-06-20T20:00:00+08:00",AVAIL:"2025-06-21T15:00:00+08:00"
};

/****************  å¸¸é‡ & å·¥å…·  ****************/
const DISCOUNT = 0.85;
const PRICE_CACHE_TTL = 5 * 60 * 1e3;
const usd = n => `${Math.floor(n).toLocaleString()} USD`;

function fetchWithTimeout(url, ms = 8000) {
  return new Promise((res, rej) => {
    const ctrl = new AbortController();
    const t = setTimeout(() => { ctrl.abort(); rej(new Error("timeout")); }, ms);
    fetch(url, { signal: ctrl.signal })
      .then(r => { clearTimeout(t); res(r); })
      .catch(rej);
  });
}

/** ä»·æ ¼è·å– + ç¼“å­˜ */
async function getTokenPrice(sym) {
  const cacheKey = `price_${sym}`;
  try {
    const cached = sessionStorage.getItem(cacheKey);
    if (cached) {
      const { p, ts } = JSON.parse(cached);
      if (Date.now() - ts < PRICE_CACHE_TTL) return p;
    }
  } catch {}
  try {
    const url = `https://api.dexscreener.com/latest/dex/tokens/${TOKENS[sym].contract.toLowerCase()}`;
    const res = await fetchWithTimeout(url, 8000);
    if (!res.ok) throw new Error("req-fail");
    const j = await res.json();
    const pairs = j.pairs || [];
    if (!pairs.length) throw new Error("empty");
    const p = pairs
      .filter(x => ["USDT", "USDC"].includes(x.quoteToken.symbol) &&
                  (x.liquidity?.usd || 0) > 5000)
      .sort((a, b) => b.liquidity.usd - a.liquidity.usd)[0] || pairs[0];
    const price = parseFloat(p.priceUsd);
    sessionStorage.setItem(cacheKey, JSON.stringify({ p: price, ts: Date.now() }));
    return price;
  } catch (e) {
    console.warn(sym, "price fetch error", e);
    return 0;
  }
}

const fmtMS = ms =>
  ms <= 0 ? "å·²ç»“æŸ" :
    `${Math.floor(ms / 3600000)}å°æ—¶ ${Math.floor(ms % 3600000 / 60000)}åˆ† ${Math.floor(ms % 60000 / 1000)}ç§’`;

let cdTimer = null, dualTimer = null;
function oneCountdown(end) {
  clearInterval(cdTimer);
  const E = new Date(end).getTime();
  cdTimer = setInterval(() => {
    const d = E - Date.now();
    document.getElementById("countdown").textContent = fmtMS(d);
    const total = Math.max(E - Date.now(), 0);
    if (total) {
      document.getElementById("countdownBarInner").style.width =
        `${Math.max(0, 100 - d / total * 100)}%`;
    }
  }, 1000);
}
function twoCountdown(list) {
  clearInterval(dualTimer);
  dualTimer = setInterval(() => {
    list.forEach(s => {
      const d = new Date(endTimes[s]).getTime() - Date.now();
      const el = document.getElementById(`cd_${s}`);
      if (el) el.textContent = fmtMS(d);
    });
  }, 1000);
}

/****************  ä¸»åˆ·æ–°æµç¨‹  ****************/
async function refreshData() {
  const btn = document.getElementById("refreshBtn");
  btn.disabled = true; btn.textContent = "â³ åŠ è½½...";
  document.getElementById("errorMsg").style.display = "none";

  const mode = document.getElementById("tokenSelect").value;
  const multi = mode === "TODAY";
  const list = multi ? ["RESOLV", "HOME"] : [mode];

  const tbody = document.getElementById("tokenBody");
  tbody.innerHTML = "";

  const mainToken = !multi ? mode : list[0];
  let mainStats = null;

  for (const sym of list) {
    const t = TOKENS[sym];
    const users = t.claimedUsers; // AVAIL/BULLA å›ºå®šï¼Œä¸å†æ‹‰æ¥å£
    const price = await getTokenPrice(sym);
    const claimed = users * t.perUserAmount;
    const uncl = t.totalSupply - claimed;
    const perVal = price ? t.perUserAmount * price : 0;
    const pvCls = perVal >= 100 ? "pv-high" : perVal >= 20 ? "pv-mid" : "";

    tbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${sym}</td>
        <td>${price ? ((price < 0.01 ? price.toFixed(5) : price.toFixed(4)) + " USD") : "-"}</td>
        <td class="${pvCls}">${price ? perVal.toFixed(2) + " USD" : "-"}</td>
        <td><div>${t.totalSupply.toLocaleString()}</div><div class="subtext">${price ? usd(t.totalSupply * price) : "-"}</div></td>
        <td><div>${uncl.toLocaleString()}</div><div class="subtext">${price ? usd(uncl * price) : "-"}</div></td>
        <td><div>${claimed.toLocaleString()}</div><div class="subtext">${price ? usd(claimed * price) : "-"}</div></td>
        <td>${Math.floor(t.totalSupply / t.perUserAmount).toLocaleString()} / ${users.toLocaleString()}</td>
      </tr>
    `);

    if (sym === mainToken) {
      const pct = ((claimed / t.totalSupply) * 100).toFixed(2);
      mainStats = { sym, price, uncl, users, pct };
    }
  }

  if (multi) {
    ["progressBlock","surplusBlock","surplusTitle","merlDeadline","countdownBar"]
      .forEach(id => document.getElementById(id).style.display = "none");
    const dc = document.getElementById("dualCountdown"); dc.innerHTML =
      list.map(s => `<div class="cd-card"><strong>${s}</strong><div class="cd-time" id="cd_${s}">åŠ è½½ä¸­...</div></div>`).join("");
    dc.style.display = "flex"; twoCountdown(list);
  } else {
    clearInterval(dualTimer);
    document.getElementById("dualCountdown").style.display = "none";
    const { sym, price, uncl, users, pct } = mainStats;
    document.getElementById("claimedPercent").textContent = pct;
    document.getElementById("progressBar").style.width = `${pct}%`;

    const adj = Math.floor((uncl / Math.max(users, 1)) * DISCOUNT);
    document.getElementById("surplusToken").textContent = adj.toLocaleString();
    document.getElementById("surplusValue").textContent = price ? usd(adj * price) : "-";

    const dl = document.getElementById("merlDeadline");
    if (endTimes[sym]) {
      const t = endTimes[sym].replace("T", " ").replace("+08:00", "");
      dl.innerHTML = `${sym} æˆªæ­¢ï¼š${t}ï¼ˆä¸œå…«åŒºï¼‰<br>å‰©ä½™æ—¶é—´ï¼š<span id="countdown">åŠ è½½ä¸­...</span>`;
      dl.style.display = "block";
      document.getElementById("countdownBar").style.display = "block";
      oneCountdown(endTimes[sym]);
    } else {
      dl.style.display = "none";
      document.getElementById("countdownBar").style.display = "none";
      clearInterval(cdTimer);
    }
    ["progressBlock","surplusBlock","surplusTitle"]
      .forEach(id => document.getElementById(id).style.display = "block");
  }

  document.getElementById("lastUpdate").textContent =
    `ğŸ“… ä¸Šæ¬¡æ›´æ–°äº ${new Date().toTimeString().slice(0, 8)}`;
  btn.disabled = false; btn.textContent = "ğŸ”„ åˆ·æ–°æ•°æ®";
}

/*****************************************************************************************
 * å†å²æ€»è§ˆ / æ’åº
 *****************************************************************************************/
let historyBuilt = false, historyVisible = false;
async function buildHistory() {
  const body = document.getElementById("historyBody");
  body.innerHTML = "<tr><td colspan='6'>åŠ è½½ä¸­...</td></tr>";

  const now = Date.now();
  let rows = [], sum = 0, sumTicket = 0;
  for (const sym in TOKENS) {
    const end = endTimes[sym] ? new Date(endTimes[sym]).getTime() : 0;
    if (!end || end > now) continue;
    const price = await getTokenPrice(sym);
    const ticket = price * TOKENS[sym].perUserAmount;
    const totalUsd = price * TOKENS[sym].totalSupply;
    sum += totalUsd; sumTicket += ticket;
    rows.push({ sym, end, price, ticket, totalUsd,
                totalQty: TOKENS[sym].totalSupply });
  }
  rows.sort((a, b) => b.end - a.end);

  body.innerHTML = "";
  rows.forEach(r => {
    body.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${r.sym}</td>
        <td>${new Date(r.end)
              .toLocaleString("zh-CN", { hour12: false })}</td>
        <td>${r.price ? (r.price < 0.01 ? r.price.toFixed(5) : r.price.toFixed(4)) + " USD" : "-"}</td>
        <td data-val="${r.ticket}">${usd(r.ticket)}</td>
        <td>${r.totalQty.toLocaleString()}</td>
        <td data-val="${r.totalUsd}">${usd(r.totalUsd)}</td>
      </tr>`);
  });

  const avgDrop = sum / rows.length || 0;
  const avgTicket = sumTicket / rows.length || 0;
  document.getElementById("historyTotal").innerHTML =
    `ğŸ¯ å¾€æœŸæ€»ç©ºæŠ•é‡‘é¢åˆè®¡ï¼š<strong>${usd(sum)}</strong> | ` +
    `ğŸ“Š å¹³å‡æ¯æ¬¡ç©ºæŠ•é‡‘é¢ï¼š<strong>${usd(avgDrop)}</strong> | ` +
    `ğŸ« å¹³å‡æ¯æœŸå•å·ä»·å€¼ï¼š<strong>${usd(avgTicket)}</strong>`;
  enableSort(); historyBuilt = true;
}

function enableSort() {
  document.querySelectorAll('#historyBlock th[data-sort-key]').forEach(th => {
    th.onclick = () => {
      const idx = [...th.parentNode.children].indexOf(th);
      const asc = !th.classList.contains("sort-asc");
      th.parentNode.querySelectorAll('th')
        .forEach(h => h.classList.remove("sort-asc","sort-desc"));
      th.classList.add(asc ? "sort-asc" : "sort-desc");

      const tbody = document.getElementById("historyBody");
      [...tbody.rows].sort((a, b) => {
        const av = parseFloat(a.children[idx].dataset.val || 0);
        const bv = parseFloat(b.children[idx].dataset.val || 0);
        return asc ? av - bv : bv - av;
      }).forEach(tr => tbody.appendChild(tr));
    };
  });
}

function toggleHistory() {
  historyVisible = !historyVisible;
  document.getElementById("historyBlock").style.display =
    historyVisible ? "block" : "none";
  document.getElementById("historyTitle").style.display =
    historyVisible ? "block" : "none";
  document.getElementById("historyBtn").textContent =
    historyVisible ? "ğŸ—‚ï¸ æ”¶èµ·å†å²" : "ğŸ—‚ï¸ å†å²æ€»è§ˆ";
  if (historyVisible && !historyBuilt) buildHistory();
}

/*****************************************************************************************
 * åˆå§‹åŒ–
 *****************************************************************************************/
function init() {
  document.getElementById("refreshBtn").onclick = refreshData;
  document.getElementById("tokenSelect").onchange = refreshData;
  document.getElementById("historyBtn").onclick = toggleHistory;
  refreshData();
  if (window._refreshTimer) clearInterval(window._refreshTimer);
  window._refreshTimer = setInterval(refreshData, 60000); // æ¯åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°
}
window.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
